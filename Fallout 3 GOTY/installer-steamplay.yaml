name: "Fallout 3: Game of the Year Edition"
game_slug: fallout-3-game-of-the-year-edition
version: Steam Play
slug: fallout-3-game-of-the-year-edition-steam-play
runner: steam

script:
  game:
    appid: 22370
    arch: win32
  require-binaries: 7z, protontricks
  files:
    - fose: https://fose.silverlock.org/beta/fose_v1_3_beta2.7z
  system:
    env:
      #PROTON_NO_ESYNC=1 PROTON_FORCE_LARGE_ADDRESS_AWARE=1 mesa_glthread=true __GL_THREADED_OPTIMIZATIONS=1 __GL_SHADER_DISK_CACHE=1 %command%
      PROTON_NO_ESYNC: 1
      PROTON_FORCE_LARGE_ADDRESS_AWARE: 1
      mesa_glthread: true
      __GL_THREADED_OPTIMIZATIONS: 1
      __GL_SHADER_DISK_CACHE: 1
  installer:

    # Updating default INI settings to include some tweaks required for better stability
    - write_config:
        description: Improving configuration...
        file: $GAMEDIR/Fallout_default.ini
        data:
          General:
            bFastExit: 1
            bUseThreadedAI: 1
            iNumHWThreads: 2
            bUseThreadedBlood: 1
            bUseThreadedMorpher: 1
            bUseThreadedTempEffects: 1
            bUseThreadedParticleSystem: 1
            bUseMultiThreadedFaceGen: 1
            bUseMultiThreadedTrees: 1
            bActorLookWithHavok: 1
            bLoadFaceGenHeadEGTFiles: 1
          BackgroundLoad:
            bBackgroundLoadLipFiles: 1
            bBackgroundCellLoads: 1
            bBackgroundPathing: 1
            bUseBackgroundFileLoader: 1
            bLoadBackgroundFaceGen: 1
            bLoadHelmetsInBackground: 1
            bCloneModelsInBackground: 1
            iBackgroundLoadExtraMaxFPS: 60
            iBackgroundLoadExtraMinFPS: 30
          MAIN:
            bCloneModelsInBackground: 1
          Pathfinding:
            bBackgroundPathing: 1
            bBackgroundNavmeshUpdate: 1
          HAVOK:
            iNumHavokThreads: 2
          Display:
            bFull Screen: 1
          Audio:
            bEnableAudioCache: 1
            bMultiThreadAudio: 0
          Controls:
            # Disable mouse acceleration
            fForegroundMouseMult: 0
            fForegroundMouseAccelBase: 0
            fForegroundMouseAccelTop: 0
            fForegroundMouseBase: 0

    - write_config:
        description: Improving visual settings...
        file: $GAMEDIR/Fallout_default.ini
        data:
          Display:
            fDefaultFOV: 90
            fPipboy1stPersonFOV: 60
            bDoTallGrassEffect: 1
          Grass:
            iMinGrassSize: 40
            iMaxGrassTypesPerTexure: 6
            fGrassMinStartFadeDistance: 0.0
            fGrassMaxStartFadeDistance: 7000.0
            fGrassDefaultStartFadeDistance: 3500.0
            fGrassFadeRange: 1000.0

    # Installing protontricks to install some winetricks and run some extra tooling
    - execute:
        description: Retrieving location of Steam Runtime...
        command: |

          cat > "$CACHE/steam-runtime-location" << EOF
          import os
          from protontricks.steam import find_steam_path, find_steam_runtime_path
          os.environ["STEAM_RUNTIME"] = "1"
          steam_path, steam_root = find_steam_path()
          with open("$CACHE/steam-runtime-location", mode="wt", encoding="utf8") as fp:
            print("\nexport STEAM_RUNTIME=\"{0}\"".format(find_steam_runtime_path(steam_root)), file=fp)
          EOF
          python3 "$CACHE/steam-runtime-location" &&
          chmod +x "$CACHE/steam-runtime-location"

    # Running the launcher for the first time,
    # to create the prefix and install base dependencies
    - execute:
        description: "Creating the prefix and generating default config...\nClose the launcher without starting the game to proceed"
        command: |

          source "$CACHE/steam-runtime-location" &&
          steam steam://rungameid/22370 &&
          sleep 8 &&
          export WINESERVER_PID=$(ps -ax | grep wineserver$ | awk '{print $1}')
          while [[ -d /proc/$WINESERVER_PID ]]; do sleep 1; done
          sleep 4 &&
          export WINESERVER_PID=$(ps -ax | grep wineserver$ | awk '{print $1}')
          while [[ -d /proc/$WINESERVER_PID ]]; do sleep 1; done

    # Applying required winetricks
    - execute:
        description: Applying required Winetricks...
        command: |

          source "$CACHE/steam-runtime-location" &&
          protontricks 22370 winxp galliumnine

    # Copying the fake xlive.dll
    - merge:
        description: Disabling GFWL...
        src: /home/d1sover/Development/lutris/Fallout 3 GOTY/xlive.dll
        dst: $GAMEDIR

    # Installing FOSE
    - execute:
        description: Installing FOSE...
        command: |

          cd "$CACHE/fose" &&
          7z x "./fose_v1_3_beta2.7z" &&
          mv -f *.dll *.exe "$GAMEDIR" &&

          export HASH_LAUNCHER="$(md5sum --binary "$GAMEDIR/FalloutLauncher.exe" | awk '{print $1}')" &&
          export HASH_LOADER="$(md5sum --binary "$GAMEDIR/fose_loader.exe" | awk '{print $1}')"

          # Do not overwrite files if FOSE has already been installed
          if [ $HASH_LAUNCHER != $HASH_LOADER ]; then
            mv "$GAMEDIR/FalloutLauncher.exe" "$GAMEDIR/FalloutLauncher.exe.bak" &&
            ln -s "$GAMEDIR/fose_loader.exe" "$GAMEDIR/FalloutLauncher.exe"
          else
            echo "FOSE already installed, skipping"
          fi
